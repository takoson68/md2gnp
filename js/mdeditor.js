var mdBoxApp=new Vue({el:"#mdBox",data:{urlBox:"URL_head",isDefault:"MyData.isDefault",mdData:"",renderData:[],endData:[],iArr:[["star","00 ~ 08"],["wb_sunny","08 ~ 12"],["brightness_high","12 ~ 18"],["brightness_2","18 ~ 24"]],cName:[],cData:[],setComment:[""],commentBox:[""],mtChart:null,eventSource:"",resizeTimer:null,downloadName:""},created:function(){this.getMd()},watch:{mdData:{handler:function(t,e){e!=[]&&this.mdToJson(t)},immediate:!1,deep:!1}},computed:{eventList(){let t=this.eventSource.replaceAll("\\\\n","\n").replace("\n`","").replace(/^\s*|\s*$/g,"");t=t.replaceAll("\t\t\t\t+ ","+ \t\t\t\t"),t=t.replaceAll("\t\t\t+ ","+ \t\t\t"),t=t.replaceAll("\t\t+ ","+ \t\t"),t=t.replaceAll("\t+ ","+ \t"),t.replace("+ `","+ `\n"),t=t.split("\n");let e=[];return t.forEach((t=>{e=[...e,t.split("+ ")[1]]})),e=e.filter((t=>t)),e}},mounted(){this.dragBox(),this.mtChart?this.mtChart.update():this.renderChart(),window.onresize=()=>{clearTimeout(this.resizeTimer),this.resizeTimer=setTimeout((()=>{this.renderChart()}),250)}},methods:{async getMd(){axios.get("../md.text").then((t=>{this.mdData=t.data,this.mdToJson(t.data)})).catch((function(t){console.log(t)}))},mdToJson(t){let e=t.replaceAll("\\\\n","\n").replace("\n`","").replace(/^\s*|\s*$/g,"");e.replace("+ `","+ `\n"),e=t.split("\n");let l=[];e.forEach((t=>{l=[...l,t.split("+ ")[1]]})),l=l.filter((t=>t));var a=/^[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/,i=[];let n=[];l.forEach(((t,e)=>{t=t.replaceAll("/","-"),a.test(t.substring(1,11))?(isNaN(1*t.substring(12,14))&&(t=t.slice(0,11)+" 25:00:00"+t.slice(11)),n.length>0?(0==i.length?(i=[{}])[0].start=n:i[i.length-1].ann=[...n],i=[...i,{time:t.substring(1,20).replace(/^\s*|\s*$/g,"").split(" "),con:t.substring(21).replace(/^\s*|\s*$/g,"")}],n=[]):i=[...i,{time:t.substring(1,20).replace(/^\s*|\s*$/g,"").split(" "),con:t.substring(21).replace(/^\s*|\s*$/g,"")}]):e==l.length-1?(i[i.length-1].ann=[...n,t],n=[]):n=[...n,t]})),this.renderData=i,this.filterTime(i)},filterTime(t){let e={};t.forEach(((t,l)=>{t.time?(null==e[t.time[0]]&&(e[t.time[0]]=[]),e[t.time[0]].push({time:t.time[1],con:t.con,ann:t.ann})):e["0000-00-00"]=[{start:t.start,time:"00:00:01"}]}));let l=Object.keys(e).sort((function(t,e){return t.replaceAll("-","")-e.replaceAll("-","")}));var a=[];l.forEach((t=>{let l=[];l=e[t].sort((function(t,e){return t.time.replaceAll(":","")-e.time.replaceAll(":","")})),a=[...a,[t,l]]})),a.forEach((t=>{t[1].forEach((e=>{1*e.time.split(":")[0]==25&&(t[1]=[t[1].pop(),...t[1]])}))})),this.endData=a,this.makeChart(a)},makeChart(t){let e={},l="";var a=0;let i="",n="",r=0;var o=[];t.forEach(((t,s)=>{"0000-00-00"!==t[0]&&t[1].forEach(((s,c)=>{let m=s.time.split(":")[0],h=!1;if("25"==m&&(m="12",h=!0,o.push([t[0],s.con])),i=t[0]+" "+m,""!==l&&""!==i){if((a=this.calculatingTime(l+" "+n,i))>1&&a<=6){let l=Math.ceil(a);for(let a=1;a<l;a++){let l=parseInt(n)+a;e[t[0]+" "+l]=0}}if(a>6&&a<=12){let l=Math.ceil(a/2);for(let a=1;a<l;a++){let l=parseInt(n)+2*a;e[t[0]+" "+l]=0}}if(a>12&&a<=48){let t=Math.ceil(a/6);for(let a=1;a<t;a++)e[l+" ( + "+6*a+"hr)"]=0}let r=720;if(a>48&&a<=r){let t=Math.ceil(a/48);for(let a=1;a<t;a++)e[l+" ( + "+2*a+"day)"]=0}if(a>r){let t=Math.ceil(a/r);for(let a=1;a<t;a++)e[l+" ( + "+a+"mo.)"]=0}}m!==n&&(r=0,n=m),r++,h?(r=0,e[t[0]+" "]=1,n="12"):e[i]=r,l=t[0]})),r=0})),this.cName=Object.keys(e);let s=[];if(this.cName.forEach((t=>{s=[...s,e[t]]})),this.cData=s,this.setComment=this.cName.map((t=>"+"!==t[0]?t:"")),this.commentBox=this.setComment.map((()=>["",-3])),s.length<4){let t=this.setComment[0]+":00:00";t=t.replaceAll("-","/");let e=new Date(t);e.setHours(e.getHours()-1);let l=`${e.getFullYear()}-${(1*e.getMonth()<10?"0":"")+(e.getMonth()+1)}-${(1*e.getDate()<10?"0":"")+e.getDate()} ${(1*e.getHours()<10?"0":"")+e.getHours()}`,a=this.setComment[this.setComment.length-1]+":00:00";a=a.replaceAll("-","/");let i=new Date(a);i.setHours(i.getHours()+1);let n=`${i.getFullYear()}-${(1*i.getMonth()<10?"0":"")+(i.getMonth()+1)}-${(1*i.getDate()<10?"0":"")+i.getDate()} ${(1*i.getHours()<10?"0":"")+i.getHours()}`;this.setComment=[l,...this.setComment,n],this.commentBox=[["",-3],...this.commentBox,["",-3]],this.cName=this.setComment,this.cData=[0,...s,0]}o.forEach((t=>{let e=this.setComment.indexOf(t[0]+" ");e>=0&&(this.commentBox[e][0]=t[1])})),this.mtChart?this.renderChart():this.mtChart.update()},calculatingTime(t,e){var l=36e5;let a=e+":00:00",i=(t+":00:00").replaceAll("-","/"),n=a.replaceAll("-","/");var r=new Date(i),o=new Date(n)-r,s=Math.floor(o/l);return s>0&&(o-=s*l),s},cutTime:t=>t.replace("-"," ").replace("-","/").split(" "),SelectPic(t){let e=parseInt(t.split(":")[0]);return e<8?"star":e<12?"wb_sunny":e<18?"brightness_high":e<24?"brightness_2":"settings_suggest"},renderChart(){var t=document.getElementById("myChart"),e=this.commentBox;this.mtChart=new Chart(t,{responsive:!0,type:"line",fillColor:"rgba(14,72,100,1)",data:{labels:[...this.cName],datasets:[{label:"事件次數統計",data:[...this.cData],backgroundColor:"rgba(139, 18, 219, 0.3)",borderColor:"rgba(139, 18, 219, 0.8)",borderWidth:1}]},options:{scales:{yAxes:[{stacked:!0,id:"y-axis-1",ticks:{min:0,beginAtZero:!0,userCallback:function(t,e,l){if(Math.floor(t)===t)return t}}}],xAxes:[{ticks:{minRotation:65,autoskip:!1,display:!0,autoSkipPadding:10}}]},elements:{line:{tension:1e-6}},hover:{animationDuration:0},animation:{onComplete:function(){var l=this.chart;(t=l.ctx).font=Chart.helpers.fontString(Chart.defaults.global.defaultFontSize,Chart.defaults.global.defaultFontStyle,Chart.defaults.global.defaultFontFamily),t.fillStyle="black",t.textAlign="center",t.textBaseline="bottom";var a=!1;this.data.datasets.forEach((function(i,n){var r=l.controller.getDatasetMeta(n);let o=r.data.length,s="#fc7232";r.data.forEach((function(l,n){var r=i.data[n];r=0==r?"":r,t.fillText(r,l._model.x,l._model.y-5);let c=e[n][0];if(c){let i=t.measureText(c).width,r=0;a||(i*=1.11,a=!0),0==n?(t.textAlign="start",r=l._model.x-5):n==o-1?(t.textAlign="end",r=l._model.x-i-5):(t.textAlign="center",r=l._model.x-i/2-5);let h=e[n][1];t.fillStyle="#000000",t.beginPath(),t.strokeStyle=s,t.lineJoin="round",t.lineWidth="8",t.fillStyle=s;let d=h>0?10*h+14:10*h-12;t.fillRect(l._model.x-1,l._model.y-d,2,10*h-6),t.strokeRect(r,l._model.y-10*h-10,i+10,18),t.fillRect(r,l._model.y-10*h-10,i+10,18);var m=t.createLinearGradient(r,l._model.y-10*h-10,r,l._model.y-10*h+9);m.addColorStop(0,s),m.addColorStop(.5,"#f12939"),m.addColorStop(1,s),t.fillStyle=m,t.fillRect(r,l._model.y-10*h-10,i+10,18),t.closePath(),t.fill(),t.stroke(),t.shadowBlur=6,t.shadowColor="rgba(107, 7, 16,.75)",t.fillStyle="#ffffff",t.font="10pt Arial",t.fillText(c,l._model.x,l._model.y-(4+10*(h-1))),t.stroke(),t.shadowBlur=0,t.fillStyle="#000000"}}))}))}}},plugins:[{beforeDraw:function(t,e){let l=document.getElementById("myChart"),a=l.getContext("2d");a.fillStyle="#ffffff",a.fillRect(0,0,l.width,l.height)}}]})},dragBox(){var t,e;let l=document.querySelector("#printable"),a=document.querySelector(".dragBox");function i(a){let i=a.clientX-e;l.style.width=t-i+"px"}function n(){document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",n),mdBoxApp.writeCom()}a.addEventListener("mousedown",(function(r){t=l.offsetWidth,r.preventDefault(),e=r.clientX-a.offsetLeft,document.addEventListener("mousemove",i),document.addEventListener("mouseup",n)}))},writeCom(){this.mtChart.destroy(),this.renderChart()},pickMeWord(t){let e=t,l=!1;e=e.replace(/`/g,(function(){return l=!l,l?"<em>":"</em>"}));let a=e.split("\t").length-1;return[e,a]}}}),fn1=t=>Promise.resolve(t),MdText=document.querySelector(".mdTopng"),Printable=document.querySelector("#printable");function screenshot(){let t=window.prompt("請輸入檔案名稱","");t&&(this.downloadName=t,fn1(TakePic("attackHistory","_history",t)).then(setTimeout((function(){window.confirm("放大攻擊次數統計圖？")?bigPic(t):TakePic_line(t)}),1500)))}function bigPic(t){MdText.setAttribute("style","flex: 0 0 0px !important; min-width: 0px !important;"),Printable.setAttribute("style","width: 100% !important;"),mdBoxApp.writeCom(),setTimeout((function(){attackHistory(t)}),2e3)}function attackHistory(t){TakePic_line("myChart","_line",t),setTimeout((function(){MdText.setAttribute("style","display:block;min-width: 200px !important;"),Printable.setAttribute("style","width: 900px !important;"),mdBoxApp.writeCom()}),500)}function TakePic(t,e,l){html2canvas(document.getElementById(t)).then((function(t){document.body.appendChild(t);let a=document.createElement("a");a.href=t.toDataURL("image/jpeg",1).replace("image/jpeg","image/octet-stream"),a.download=l+e+".jpg",a.click()}))}function TakePic_line(t,e,l){let a=document.getElementById(t),i=document.createElement("a");i.href=a.toDataURL("image/jpeg",1).replace("image/jpeg","image/octet-stream"),i.download=l+e+".jpg",i.click()}